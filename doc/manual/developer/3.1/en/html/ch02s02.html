<html><head>
<!-- otrs.github.io -->
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="../../../../../documentation.css">
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="../../../../../documentation.js"></script>
<!-- otrs.github.io -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Database Mechanism</title><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="OTRS 3.1 - Developer Manual"><link rel="up" href="how-it-works.html" title="Chapter 2. OTRS Internals - How it Works"><link rel="prev" href="how-it-works.html" title="Chapter 2. OTRS Internals - How it Works"><link rel="next" href="ch02s03.html" title="Log Mechanism"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Database Mechanism</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="how-it-works.html">Prev</a> </td><th width="60%" align="center">Chapter 2. OTRS Internals - How it Works</th><td width="20%" align="right"> <a accesskey="n" href="ch02s03.html">Next</a></td></tr></table><hr></div><div class="section" title="Database Mechanism"><div class="titlepage"><div><div><h2 class="title"><a name="idp15099824"></a>Database Mechanism</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch02s02.html#database-how-it-works">How it works</a></span></dt><dd><dl><dt><span class="section"><a href="ch02s02.html#database-sql">SQL</a></span></dt><dd><dl><dt><span class="section"><a href="ch02s02.html#database-sql-do">INSERT/UPDATE/DELETE</a></span></dt><dt><span class="section"><a href="ch02s02.html#database-sql-select">SELECT</a></span></dt><dt><span class="section"><a href="ch02s02.html#database-sql-quote">QUOTE</a></span></dt></dl></dd><dt><span class="section"><a href="ch02s02.html#database-xml">XML</a></span></dt><dd><dl><dt><span class="section"><a href="ch02s02.html#database-xml-insert">INSERT</a></span></dt><dt><span class="section"><a href="ch02s02.html#database-xml-create">CREATE TABLE</a></span></dt><dt><span class="section"><a href="ch02s02.html#database-xml-drop">DROP TABLE</a></span></dt><dt><span class="section"><a href="ch02s02.html#database-xml-alter">ALTER TABLE</a></span></dt><dt><span class="section"><a href="ch02s02.html#database-xml-code">Code to process XML</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="ch02s02.html#database-driver">Database Drivers</a></span></dt><dt><span class="section"><a href="ch02s02.html#database-supported">Supported Databases</a></span></dt></dl></div><p>
OTRS comes with a database layer that supports different databases.
    </p><div class="section" title="How it works"><div class="titlepage"><div><div><h3 class="title"><a name="database-how-it-works"></a>How it works</h3></div></div></div><p>
The database layer (Kernel::System::DB) has two input options: SQL and XML.
        </p><div class="section" title="SQL"><div class="titlepage"><div><div><h4 class="title"><a name="database-sql"></a>SQL</h4></div></div></div><p>
The SQL interface should be used for normal database actions (SELECT, INSERT,
UPDATE, ...). It can be used like a normal Perl DBI interface.
            </p><div class="section" title="INSERT/UPDATE/DELETE"><div class="titlepage"><div><div><h5 class="title"><a name="database-sql-do"></a>INSERT/UPDATE/DELETE</h5></div></div></div><pre class="programlisting">
$Self-&gt;{DBObject}-&gt;Do(
    SQL=&gt; "INSERT INTO table (name, id) VALUES ('SomeName', 123)",
);

$Self-&gt;{DBObject}-&gt;Do(
    SQL=&gt; "UPDATE table SET name = 'SomeName', id = 123",
);

$Self-&gt;{DBObject}-&gt;Do(
    SQL=&gt; "DELETE FROM table WHERE id = 123",
);
            </pre></div><div class="section" title="SELECT"><div class="titlepage"><div><div><h5 class="title"><a name="database-sql-select"></a>SELECT</h5></div></div></div><pre class="programlisting">
my $SQL = "SELECT id FROM table WHERE tn = '123'";

$Self-&gt;{DBObject}-&gt;Prepare(SQL =&gt; $SQL, Limit =&gt; 15);

while (my @Row = $Self-&gt;{DBObject}-&gt;FetchrowArray()) {
    $Id = $Row[0];
}
return $Id;
            </pre><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
Take care to use Limit as param and not in the SQL string because
not all databases support LIMIT in SQL strings.
                </p></div><pre class="programlisting">
my $SQL = "SELECT id FROM table WHERE tn = ? AND group = ?";

$Self-&gt;{DBObject}-&gt;Prepare(
    SQL   =&gt; $SQL,
    Limit =&gt; 15,
    Bind  =&gt; [ $Tn, $Group ],
);

while (my @Row = $Self-&gt;{DBObject}-&gt;FetchrowArray()) {
    $Id = $Row[0];
}
return $Id;
            </pre><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
Use the Bind attribute where ever you can, especially for long statements. If
you use Bind you do not need the function Quote().
                </p></div></div><div class="section" title="QUOTE"><div class="titlepage"><div><div><h5 class="title"><a name="database-sql-quote"></a>QUOTE</h5></div></div></div><p>
String:
                    </p><pre class="programlisting">
my $QuotedString = $Self-&gt;{DBObject}-&gt;Quote("It's a problem!");
                    </pre><p>
                </p><p>
Integer:
                    </p><pre class="programlisting">
my $QuotedInteger = $Self-&gt;{DBObject}-&gt;Quote('123', 'Integer');
                    </pre><p>
                </p><p>
Number:
                    </p><pre class="programlisting">
my $QuotedNumber = $Self-&gt;{DBObject}-&gt;Quote('21.35', 'Number');
                    </pre><p>
                </p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
Please use the Bind attribute instead of Quote() where ever you can.
                    </p></div></div></div><div class="section" title="XML"><div class="titlepage"><div><div><h4 class="title"><a name="database-xml"></a>XML</h4></div></div></div><p>
The XML interface should be used for INSERT, CREATE TABLE, DROP TABLE and ALTER TABLE.
As this syntax is different from database to database, using it makes sure that
you write applications that can be used in all of them.
            </p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
The &lt;Insert&gt; has changed in &gt;=2.2. Values are now used in content area (not longer in attribut Value).
                </p></div><div class="section" title="INSERT"><div class="titlepage"><div><div><h5 class="title"><a name="database-xml-insert"></a>INSERT</h5></div></div></div><pre class="programlisting">
&lt;Insert Table="some_table"&gt;
    &lt;Data Key="id"&gt;1&lt;/Data&gt;
    &lt;Data Key="description" Type="Quote"&gt;exploit&lt;/Data&gt;
&lt;/Insert&gt;
            </pre></div><div class="section" title="CREATE TABLE"><div class="titlepage"><div><div><h5 class="title"><a name="database-xml-create"></a>CREATE TABLE</h5></div></div></div><p>
Possible data types are: BIGINT, SMALLINT, INTEGER, VARCHAR (Size=1-1000000), DATE (Format: yyyy-mm-dd hh:mm:ss) and LONGBLOB.
            </p><pre class="programlisting">
&lt;TableCreate Name="calendar_event"&gt;
    &lt;Column Name="id" Required="true" PrimaryKey="true" AutoIncrement="true" Type="BIGINT"/&gt;
    &lt;Column Name="title" Required="true" Size="250" Type="VARCHAR"/&gt;
    &lt;Column Name="content" Required="false" Size="250" Type="VARCHAR"/&gt;
    &lt;Column Name="start_time" Required="true" Type="DATE"/&gt;
    &lt;Column Name="end_time" Required="true" Type="DATE"/&gt;
    &lt;Column Name="owner_id" Required="true" Type="INTEGER"/&gt;
    &lt;Column Name="event_status" Required="true" Size="50" Type="VARCHAR"/&gt;
    &lt;Index Name="calendar_event_title"&gt;
        &lt;IndexColumn Name="title"/&gt;
    &lt;/Index&gt;
    &lt;Unique Name="calendar_event_title"&gt;
        &lt;UniqueColumn Name="title"/&gt;
    &lt;/Unique&gt;
    &lt;ForeignKey ForeignTable="users"&gt;
        &lt;Reference Local="owner_id" Foreign="id"/&gt;
    &lt;/ForeignKey&gt;
&lt;/TableCreate&gt;
            </pre></div><div class="section" title="DROP TABLE"><div class="titlepage"><div><div><h5 class="title"><a name="database-xml-drop"></a>DROP TABLE</h5></div></div></div><pre class="programlisting">
&lt;TableDrop Name="calendar_event"/&gt;
            </pre></div><div class="section" title="ALTER TABLE"><div class="titlepage"><div><div><h5 class="title"><a name="database-xml-alter"></a>ALTER TABLE</h5></div></div></div><p>
            The following shows an example of add, change and drop columns.
            </p><pre class="programlisting">
&lt;TableAlter Name="calendar_event"&gt;
    &lt;ColumnAdd Name="test_name" Type="varchar" Size="20" Required="true"/&gt;

    &lt;ColumnChange NameOld="test_name" NameNew="test_title" Type="varchar" Size="30" Required="true"/&gt;

    &lt;ColumnChange NameOld="test_title" NameNew="test_title" Type="varchar" Size="100" Required="false"/&gt;

    &lt;ColumnDrop Name="test_title"/&gt;

    &lt;IndexCreate Name="index_test3"&gt;
        &lt;IndexColumn Name="test3"/&gt;
    &lt;/IndexCreate&gt;

    &lt;IndexDrop Name="index_test3"/&gt;

    &lt;UniqueCreate Name="uniq_test3"&gt;
        &lt;UniqueColumn Name="test3"/&gt;
    &lt;/UniqueCreate&gt;

    &lt;UniqueDrop Name="uniq_test3"/&gt;
&lt;/TableAlter&gt;
            </pre><p>
            The next shows an example how to rename a table.
            </p><pre class="programlisting">
&lt;TableAlter NameOld="calendar_event" NameNew="calendar_event_new"/&gt;
            </pre></div><div class="section" title="Code to process XML"><div class="titlepage"><div><div><h5 class="title"><a name="database-xml-code"></a>Code to process XML</h5></div></div></div><pre class="programlisting">
my @XMLARRAY = @{$Self-&gt;ParseXML(String =&gt; $XML)};

my @SQL = $Self-&gt;{DBObject}-&gt;SQLProcessor(
    Database =&gt; \@XMLARRAY,
);
push(@SQL, $Self-&gt;{DBObject}-&gt;SQLProcessorPost());

for (@SQL) {
    $Self-&gt;{DBObject}-&gt;Do(SQL =&gt; $_);
}
            </pre></div></div></div><div class="section" title="Database Drivers"><div class="titlepage"><div><div><h3 class="title"><a name="database-driver"></a>Database Drivers</h3></div></div></div><p>
            The database drivers are located under <code class="filename">$OTRS_HOME/Kernel/System/DB/*.pm</code>.
        </p></div><div class="section" title="Supported Databases"><div class="titlepage"><div><div><h3 class="title"><a name="database-supported"></a>Supported Databases</h3></div></div></div><p>
        </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>MySQL</p></li><li class="listitem"><p>PostgreSQL</p></li><li class="listitem"><p>Oracle</p></li><li class="listitem"><p>MSSQL</p></li><li class="listitem"><p>DB2</p></li></ul></div><p>
        </p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="how-it-works.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="how-it-works.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch02s03.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 2. OTRS Internals - How it Works </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Log Mechanism</td></tr></table></div></body></html>
