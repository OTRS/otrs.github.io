<!DOCTYPE html>
<html lang="en" xml:lang="en">
<head>
<!-- otrs.github.io -->
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../../../../../../documentation.css">
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="../../../../../../documentation.js"></script>
<link rel="icon" type="image/png" sizes="32x32" href="../../../../../../../images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../../../../../../images/favicon-16x16.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script>
$(document).ready(function() {

    // Hint languages to prevent false matches (php for example).
    hljs.configure({
        languages: ['perl', 'javascript', 'xml', 'html', 'css', 'json', 'yaml']
    });

    // programlistings in manuals
    $('pre.programlisting').each(function(i, block) {
        hljs.highlightBlock(block);
    });
    // code snippets in Perl API docs
    $('.pod pre').addClass('perl').each(function(i, block) {
        hljs.highlightBlock(block);
    });
});</script>
<!-- otrs.github.io -->

<title>Kernel::System::DB &mdash; OTRS 8.0 API Reference Perl</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body><div class="box">
  <h1 class="t1">OTRS 8.0 API Reference Perl</h1>
  <table>
    <tr>
      <td class="label">Description</td>
      <td class="cell">manuals and libraries</td>
    </tr>
  </table>
</div>
<div class="path">
  <a href="../../index.html">OTRS 8.0 API Reference Perl</a> &gt; Perl Modules &gt;
  Kernel::System::DB
</div>
<div>

</div>

<div class="pod">


<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a></li>
  <li><a href="#PUBLIC-INTERFACE">PUBLIC INTERFACE</a>
    <ul>
      <li><a href="#new">new()</a></li>
      <li><a href="#Connect">Connect()</a></li>
      <li><a href="#Disconnect">Disconnect()</a></li>
      <li><a href="#Version">Version()</a></li>
      <li><a href="#Quote">Quote()</a></li>
      <li><a href="#Error">Error()</a></li>
      <li><a href="#Do">Do()</a></li>
      <li><a href="#Prepare">Prepare()</a></li>
      <li><a href="#FetchrowArray">FetchrowArray()</a></li>
      <li><a href="#ListTables">ListTables()</a></li>
      <li><a href="#GetColumnNames">GetColumnNames()</a></li>
      <li><a href="#SelectAll">SelectAll()</a></li>
      <li><a href="#GetDatabaseFunction">GetDatabaseFunction()</a></li>
      <li><a href="#SQLProcessor">SQLProcessor()</a></li>
      <li><a href="#SQLProcessorPost">SQLProcessorPost()</a></li>
      <li><a href="#QueryCondition">QueryCondition()</a></li>
      <li><a href="#QueryInCondition">QueryInCondition()</a></li>
      <li><a href="#QueryStringEscape">QueryStringEscape()</a></li>
      <li><a href="#Ping">Ping()</a></li>
      <li><a href="#Check">Check()</a></li>
    </ul>
  </li>
</ul>

<h1 id="NAME">NAME</h1>

<p>Kernel::System::DB - global database interface</p>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<p>All database functions to connect/insert/update/delete/... to a database.</p>

<h1 id="PUBLIC-INTERFACE">PUBLIC INTERFACE</h1>

<h2 id="new">new()</h2>

<p>create database object, with database connect.. Usually you do not use it directly, instead use:</p>

<pre><code>    use Kernel::System::ObjectManager;
    local $Kernel::OM = Kernel::System::ObjectManager-&gt;new(
        &#39;Kernel::System::DB&#39; =&gt; {
            # if you don&#39;t supply the following parameters, the ones found in
            # Kernel/Config.pm are used instead:
            DatabaseDSN  =&gt; &#39;DBI:odbc:database=123;host=localhost;&#39;,
            DatabaseUser =&gt; &#39;user&#39;,
            DatabasePw   =&gt; &#39;somepass&#39;,
            Type         =&gt; &#39;mysql&#39;,
            Attribute =&gt; {
                LongTruncOk =&gt; 1,
                LongReadLen =&gt; 100*1024,
            },
        },
    );
    my $DBObject = $Kernel::OM-&gt;Get(&#39;Kernel::System::DB&#39;);</code></pre>

<h2 id="Connect">Connect()</h2>

<p>to connect to a database</p>

<pre><code>    $DBObject-&gt;Connect();</code></pre>

<h2 id="Disconnect">Disconnect()</h2>

<p>to disconnect from a database</p>

<pre><code>    $DBObject-&gt;Disconnect();</code></pre>

<h2 id="Version">Version()</h2>

<p>to get the database version</p>

<pre><code>    my $DBVersion = $DBObject-&gt;Version();

    returns: &quot;MySQL 5.1.1&quot;;</code></pre>

<h2 id="Quote">Quote()</h2>

<p>to quote sql parameters</p>

<pre><code>    quote strings, date and time:
    =============================
    my $DBString = $DBObject-&gt;Quote( &quot;This isn&#39;t a problem!&quot; );

    my $DBString = $DBObject-&gt;Quote( &quot;2005-10-27 20:15:01&quot; );

    quote integers:
    ===============
    my $DBString = $DBObject-&gt;Quote( 1234, &#39;Integer&#39; );

    quote numbers (e. g. 1, 1.4, 42342.23424):
    ==========================================
    my $DBString = $DBObject-&gt;Quote( 1234, &#39;Number&#39; );</code></pre>

<h2 id="Error">Error()</h2>

<p>to retrieve database errors</p>

<pre><code>    my $ErrorMessage = $DBObject-&gt;Error();</code></pre>

<h2 id="Do">Do()</h2>

<p>to insert, update or delete values</p>

<pre><code>    $DBObject-&gt;Do( SQL =&gt; &quot;INSERT INTO table (name) VALUES (&#39;dog&#39;)&quot; );

    $DBObject-&gt;Do( SQL =&gt; &quot;DELETE FROM table&quot; );

    you also can use DBI bind values (used for large strings):

    my $Var1 = &#39;dog1&#39;;
    my $Var2 = &#39;dog2&#39;;

    $DBObject-&gt;Do(
        SQL  =&gt; &quot;INSERT INTO table (name1, name2) VALUES (?, ?)&quot;,
        Bind =&gt; [ \$Var1, \$Var2 ],
    );</code></pre>

<h2 id="Prepare">Prepare()</h2>

<p>to prepare a SELECT statement</p>

<pre><code>    $DBObject-&gt;Prepare(
        SQL   =&gt; &quot;SELECT id, name FROM table&quot;,
        Limit =&gt; 10,
    );</code></pre>

<p>or in case you want just to get row 10 until 30</p>

<pre><code>    $DBObject-&gt;Prepare(
        SQL   =&gt; &quot;SELECT id, name FROM table&quot;,
        Start =&gt; 10,
        Limit =&gt; 20,
    );</code></pre>

<p>in case you don&#39;t want utf-8 encoding for some columns, use this:</p>

<pre><code>    $DBObject-&gt;Prepare(
        SQL    =&gt; &quot;SELECT id, name, content FROM table&quot;,
        Encode =&gt; [ 1, 1, 0 ],
    );</code></pre>

<p>you also can use DBI bind values, required for large strings:</p>

<pre><code>    my $Var1 = &#39;dog1&#39;;
    my $Var2 = &#39;dog2&#39;;

    $DBObject-&gt;Prepare(
        SQL    =&gt; &quot;SELECT id, name, content FROM table WHERE name_a = ? AND name_b = ?&quot;,
        Encode =&gt; [ 1, 1, 0 ],
        Bind   =&gt; [ \$Var1, \$Var2 ],
    );</code></pre>

<h2 id="FetchrowArray">FetchrowArray()</h2>

<p>to process the results of a SELECT statement</p>

<pre><code>    $DBObject-&gt;Prepare(
        SQL   =&gt; &quot;SELECT id, name FROM table&quot;,
        Limit =&gt; 10
    );

    while (my @Row = $DBObject-&gt;FetchrowArray()) {
        print &quot;$Row[0]:$Row[1]\n&quot;;
    }</code></pre>

<h2 id="ListTables">ListTables()</h2>

<p>list all tables in the OTRS database.</p>

<pre><code>    my @Tables = $DBObject-&gt;ListTables();</code></pre>

<p>On databases like Oracle it could happen that too many tables are listed (all belonging to the current user), if the user also has permissions for other databases. So this list should only be used for verification of the presence of expected OTRS tables.</p>

<h2 id="GetColumnNames">GetColumnNames()</h2>

<p>to retrieve the column names of a database statement</p>

<pre><code>    $DBObject-&gt;Prepare(
        SQL   =&gt; &quot;SELECT * FROM table&quot;,
        Limit =&gt; 10
    );

    my @Names = $DBObject-&gt;GetColumnNames();</code></pre>

<h2 id="SelectAll">SelectAll()</h2>

<p>returns all available records of a SELECT statement. In essence, this calls Prepare() and FetchrowArray() to get all records.</p>

<pre><code>    my $ResultAsArrayRef = $DBObject-&gt;SelectAll(
        SQL   =&gt; &quot;SELECT id, name FROM table&quot;,
        Limit =&gt; 10
    );</code></pre>

<p>You can pass the same arguments as to the Prepare() method.</p>

<p>Returns undef (if query failed), or an array ref (if query was successful):</p>

<pre><code>  my $ResultAsArrayRef = [
    [ 1, &#39;itemOne&#39; ],
    [ 2, &#39;itemTwo&#39; ],
    [ 3, &#39;itemThree&#39; ],
    [ 4, &#39;itemFour&#39; ],
  ];</code></pre>

<h2 id="GetDatabaseFunction">GetDatabaseFunction()</h2>

<p>to get database functions like</p>

<pre><code>    - Limit
    - DirectBlob
    - QuoteSingle
    - QuoteBack
    - QuoteSemicolon
    - NoLikeInLargeText
    - CurrentTimestamp
    - Encode
    - Comment
    - ShellCommit
    - ShellConnect
    - Connect
    - LikeEscapeString

    my $What = $DBObject-&gt;GetDatabaseFunction(&#39;DirectBlob&#39;);</code></pre>

<h2 id="SQLProcessor">SQLProcessor()</h2>

<p>generate database-specific sql syntax (e. g. CREATE TABLE ...)</p>

<pre><code>    my @SQL = $DBObject-&gt;SQLProcessor(
        Database =&gt;
            [
                Tag  =&gt; &#39;TableCreate&#39;,
                Name =&gt; &#39;table_name&#39;,
            ],
            [
                Tag  =&gt; &#39;Column&#39;,
                Name =&gt; &#39;col_name&#39;,
                Type =&gt; &#39;VARCHAR&#39;,
                Size =&gt; 150,
            ],
            [
                Tag  =&gt; &#39;Column&#39;,
                Name =&gt; &#39;col_name2&#39;,
                Type =&gt; &#39;INTEGER&#39;,
            ],
            [
                Tag =&gt; &#39;TableEnd&#39;,
            ],
        ForceConstraintSQL =&gt; 1,    # optional, skips safety measures for incides etc. (used for table structure check)
    );</code></pre>

<h2 id="SQLProcessorPost">SQLProcessorPost()</h2>

<p>generate database-specific sql syntax, post data of SQLProcessor(), e. g. foreign keys</p>

<pre><code>    my @SQL = $DBObject-&gt;SQLProcessorPost();</code></pre>

<h2 id="QueryCondition">QueryCondition()</h2>

<p>generate SQL condition query based on a search expression</p>

<pre><code>    my $SQL = $DBObject-&gt;QueryCondition(
        Key   =&gt; &#39;some_col&#39;,
        Value =&gt; &#39;(ABC+DEF)&#39;,
    );

    add SearchPrefix and SearchSuffix to search, in this case
    for &quot;(ABC*+DEF*)&quot;

    my $SQL = $DBObject-&gt;QueryCondition(
        Key          =&gt; &#39;some_col&#39;,
        Value        =&gt; &#39;(ABC+DEF)&#39;,
        SearchPrefix =&gt; &#39;&#39;,
        SearchSuffix =&gt; &#39;*&#39;
        Extended     =&gt; 1, # use also &quot; &quot; as &quot;&amp;&amp;&quot;, e.g. &quot;bob smith&quot; -&gt; &quot;bob&amp;&amp;smith&quot;
    );

    example of a more complex search condition

    my $SQL = $DBObject-&gt;QueryCondition(
        Key   =&gt; &#39;some_col&#39;,
        Value =&gt; &#39;((ABC&amp;&amp;DEF)&amp;&amp;!GHI)&#39;,
    );

    for a earch condition over more columns

    my $SQL = $DBObject-&gt;QueryCondition(
        Key   =&gt; [ &#39;some_col_a&#39;, &#39;some_col_b&#39; ],
        Value =&gt; &#39;((ABC&amp;&amp;DEF)&amp;&amp;!GHI)&#39;,
    );

    Returns the SQL string or &quot;1=0&quot; if the query could not be parsed correctly.

    my $SQL = $DBObject-&gt;QueryCondition(
        Key      =&gt; [ &#39;some_col_a&#39;, &#39;some_col_b&#39; ],
        Value    =&gt; &#39;((ABC&amp;&amp;DEF)&amp;&amp;!GHI)&#39;,
        BindMode =&gt; 1,
    );

    return the SQL String with ?-values and a array with values references:

    $BindModeResult = (
        &#39;SQL&#39;    =&gt; &#39;WHERE testa LIKE ? AND testb NOT LIKE ? AND testc = ?&#39;
        &#39;Values&#39; =&gt; [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;],
    )</code></pre>

<p>Note that the comparisons are usually performed case insensitively. Only <code>VARCHAR</code> columns with a size less or equal 3998 are supported, as for locator objects the functioning of SQL function <code>LOWER()</code> can&#39;t be guaranteed.</p>

<h2 id="QueryInCondition">QueryInCondition()</h2>

<p>Generate a SQL IN condition query based on the given table key and values.</p>

<pre><code>    my $SQL = $DBObject-&gt;QueryInCondition(
        Key       =&gt; &#39;table.column&#39;,
        Values    =&gt; [ 1, 2, 3, 4, 5, 6 ],
        QuoteType =&gt; &#39;(undef|Integer|Number)&#39;,
        BindMode  =&gt; (0|1),
        Negate    =&gt; (0|1),
    );</code></pre>

<p>Returns the SQL string:</p>

<pre><code>    my $SQL = &quot;ticket_id IN (1, 2, 3, 4, 5, 6)&quot;</code></pre>

<p>Return a separated IN condition for more then <code>MaxParamCountForInCondition</code> values:</p>

<pre><code>    my $SQL = &quot;( ticket_id IN ( 1, 2, 3, 4, 5, 6 ... ) OR ticket_id IN ( ... ) )&quot;</code></pre>

<p>Return the SQL String with ?-values and a array with values references in bind mode:</p>

<pre><code>    $BindModeResult = (
        &#39;SQL&#39;    =&gt; &#39;ticket_id IN (?, ?, ?, ?, ?, ?)&#39;,
        &#39;Values&#39; =&gt; [1, 2, 3, 4, 5, 6],
    );

    or

    $BindModeResult = (
        &#39;SQL&#39;    =&gt; &#39;( ticket_id IN (?, ?, ?, ?, ?, ?) OR ticket_id IN ( ?, ... ) )&#39;,
        &#39;Values&#39; =&gt; [1, 2, 3, 4, 5, 6, ... ],
    );</code></pre>

<p>Returns the SQL string for a negated in condition:</p>

<pre><code>    my $SQL = &quot;ticket_id NOT IN (1, 2, 3, 4, 5, 6)&quot;

    or

    my $SQL = &quot;( ticket_id NOT IN ( 1, 2, 3, 4, 5, 6 ... ) AND ticket_id NOT IN ( ... ) )&quot;</code></pre>

<h2 id="QueryStringEscape">QueryStringEscape()</h2>

<p>escapes special characters within a query string</p>

<pre><code>    my $QueryStringEscaped = $DBObject-&gt;QueryStringEscape(
        QueryString =&gt; &#39;customer with (brackets) and &amp; and -&#39;,
    );

    Result would be a string in which all special characters are escaped.
    Special characters are those which are returned by _SpecialCharactersGet().

    $QueryStringEscaped = &#39;customer with \(brackets\) and \&amp; and \-&#39;;</code></pre>

<h2 id="Ping">Ping()</h2>

<p>checks if the database is reachable</p>

<pre><code>    my $Success = $DBObject-&gt;Ping(
        AutoConnect =&gt; 0,  # default 1
    );</code></pre>

<h2 id="Check">Check()</h2>

<p>Perform several database checks.</p>

<pre><code>    my %CheckResult = $DBObject-&gt;Check(
        Mode   =&gt; &#39;ConsoleCommand&#39;,      # ConsoleCommand | SupportDataCollector | Installer
        Repair =&gt; 1,                     # optional ( 0 | 1) Default 0 (will automatically repair certain issues,
                                         #    if supported by the submodule)
    );

    Returns:

        %CheckResult = (
            Success =&gt; 1,
            Result =&gt; [
                {
                    Identifier =&gt; &#39;Kernel::System::DB::Check::OutdatedTables&#39;,  # Shows from which module this result is coming from.
                    Label      =&gt; &#39;Outdated Tables&#39;,                            # Label to show what this check is doing.
                    State      =&gt; &#39;OK&#39;,                                         # State can be: OK, Warning, Problem, Info, Unknown.
                    Value      =&gt; &#39;&#39;,                                           # Additional data in case (used mostly if state is not OK).
                    Message    =&gt; &#39;&#39;,                                           # Message that describes the Problem if neccessary.
                },
                {
                    Identifier =&gt; &#39;Kernel::System::DB::Check::TablePresence&#39;,
                    Label      =&gt; Table Presence&#39;,
                    State      =&gt; &#39;Problem&#39;,
                    Value      =&gt; &#39;ticket, ticket_history&#39;,
                    Message    =&gt; &#39;Tables found which are not present in the database.&#39;,
                },
        );</code></pre>

</div><div class="footer">generated by <a href="http://metacpan.org/module/Pod::ProjectDocs">Pod::ProjectDocs</a></div></body></html>

